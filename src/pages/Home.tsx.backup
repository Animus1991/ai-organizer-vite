// src/pages/Home.tsx
import { useEffect, useMemo, useState } from "react";
import { useAuth } from "../auth/AuthProvider";
import {
  listUploads,
  uploadFile as apiUploadFile,
  listSegments,
  segmentDocument,
  listSegmentations,
  deleteUpload,
  UploadItemDTO,
} from "../lib/api";
import { useNavigate } from "react-router-dom";
import SegmentationSummaryBar from "../components/SegmentationSummaryBar";
import { useLoading } from "../hooks/useLoading";

type SegmentRow = {
  id: number;
  orderIndex: number;
  mode: string;
  title: string;
  content: string;
  start?: number;
  end?: number;
  createdAt?: string | null;
};

type SegSummaryRow = {
  mode: "qa" | "paragraphs";
  count: number;
  lastSegmentedAt?: string | null;
};

function preview120(s: string) {
  const oneLine = (s ?? "").replace(/\s+/g, " ").trim();
  return oneLine.length > 120 ? oneLine.slice(0, 120) + "…" : oneLine;
}

function safeFileName(name: string) {
  return name.replace(/[<>:"/\\|?*\x00-\x1F]/g, "_").slice(0, 120).trim() || "export";
}

function statusBadge(parseStatus?: string) {
  if (parseStatus === "ok") return "✅ ok";
  if (parseStatus === "failed") return "⛔ failed";
  if (parseStatus === "pending") return "⏳ pending";
  return parseStatus ? `• ${parseStatus}` : "—";
}

export default function Home() {
  const { user, logout } = useAuth();
  const nav = useNavigate();

  const { loading: uploadsLoading } = useLoading();
  const { loading: deleteLoading } = useLoading();
  const { loading: uploadLoading } = useLoading();

  const [segSummary, setSegSummary] = useState<SegSummaryRow[]>([]);

  const [file, setFile] = useState<File | null>(null);
  const [documentId, setDocumentId] = useState<number | null>(null);
  const [mode, setMode] = useState<"qa" | "paragraphs">("qa");

  const [segments, setSegments] = useState<SegmentRow[]>([]);
  const [status, setStatus] = useState<string>("");

  const [uploads, setUploads] = useState<UploadItemDTO[]>([]);

  // side panel state
  const [openSeg, setOpenSeg] = useState<SegmentRow | null>(null);
  const [copied, setCopied] = useState(false);

  // QoL state
  const [query, setQuery] = useState("");
  const [modeFilter, setModeFilter] = useState<"all" | "qa" | "paragraphs">("all");

  async function fetchUploads() {
    try {
      const data = await listUploads();
      setUploads(Array.isArray(data) ? data : []);
    } catch (e: any) {
      setStatus(e?.message ?? "Failed to load uploads");
    }
  }

  async function loadSegmentationSummary(docId: number) {
    try {
      const rows = await listSegmentations(docId);
      setSegSummary(Array.isArray(rows) ? (rows as SegSummaryRow[]) : []);
    } catch {
      setSegSummary([]);
    }
  }

  useEffect(() => {
    if (user) fetchUploads();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user]);

  useEffect(() => {
    if (documentId) loadSegmentationSummary(documentId);
    else setSegSummary([]);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [documentId]);

  const selectedUpload = useMemo(() => {
    if (!documentId) return null;
    return uploads.find((u) => u.documentId === documentId) ?? null;
  }, [documentId, uploads]);

  const localDuplicateHint = useMemo(() => {
    if (!file) return null;
    const hit = uploads.find((u) => u.filename === file.name && u.sizeBytes === file.size);
    return hit ?? null;
  }, [file, uploads]);

  const canSegment = useMemo(() => {
    if (!selectedUpload) return false;
    return selectedUpload.parseStatus === "ok";
  }, [selectedUpload]);

  const filteredSegments = useMemo(() => {
    const q = query.trim().toLowerCase();
    return segments.filter((s) => {
      const modeOk = modeFilter === "all" ? true : s.mode === modeFilter;
      if (!modeOk) return false;
      if (!q) return true;
      const hay = `${s.title ?? ""} ${s.content ?? ""}`.toLowerCase();
      return hay.includes(q);
    });
  }, [segments, query, modeFilter]);

  async function doUpload() {
    if (!file) return;

    setStatus("Uploading...");
    setOpenSeg(null);

    try {
      const data = await apiUploadFile(file);
      if (data.parseStatus === "failed") {
        setStatus(
          `Uploaded, but parse FAILED (${data.filename}). Reason: ${data.parseError ?? "unknown error"}`
        );
      } else if (data.deduped) {
        setStatus(
          `File deduped: ${data.filename}. Existing document used.`
        );
      } else {
        setStatus(`Uploaded: ${data.filename}`);
      }

      setDocumentId(data.documentId || null);
      await fetchUploads();
    } catch (e: any) {
      setStatus(e?.message ?? "Upload failed");
    }
  }

  function extractCount(payload: any): number | null {
    if (!payload) return null;
    if (typeof payload.count === "number") return payload.count;
    if (typeof payload.inserted === "number") return payload.inserted;
    if (typeof payload.created === "number") return payload.created;
    if (typeof payload.segments_created === "number") return payload.segments_created;
    if (typeof payload.total === "number") return payload.total;
    if (Array.isArray(payload)) return payload.length;
    if (Array.isArray(payload.items)) return payload.items.length;
    if (typeof payload.segments === "number") return payload.segments;
    return null;
  }

  async function segmentDoc() {
    if (!documentId) return;

    if (!canSegment) {
      setStatus(
        `Cannot segment: document parseStatus is "${selectedUpload?.parseStatus}". Fix upload/parse first.`
      );
      return;
    }

    setStatus("Segmenting...");
    setOpenSeg(null);

    try {
      const data = await segmentDocument(documentId, mode);
      await loadSegmentationSummary(documentId);

      const count = extractCount(data);
      setStatus(
        count !== null ? `Segmented: ${count} segments` : `Segment response: ${JSON.stringify(data)}`
      );
    } catch (e: any) {
      setStatus(e?.message ?? "Segment failed");
    }
  }

  async function loadSegments() {
    if (!documentId) return;

    setStatus("Loading segments...");
    setOpenSeg(null);

    try {
      const response = await listSegments(documentId, mode);
      const items = Array.isArray(response.items) ? response.items : [];
      setModeFilter(mode);
      setSegments(items);
      setStatus(`Loaded ${items.length} segments`);
    } catch (e: any) {
      setStatus(e?.message ?? "List failed");
    }
  }

  async function deleteSelectedUpload() {
    if (!selectedUpload) return;

    const ok = window.confirm(`Delete upload "${selectedUpload.filename}"?`);
    if (!ok) return;

    try {
      await deleteUpload(selectedUpload.uploadId);
      setQuery("");
      setModeFilter("all");
      await fetchUploads();
    } catch (e: any) {
      setStatus(e?.message ?? "Delete failed");
    }
  }

  async function copyOpenSegment(withTitle: boolean) {
    if (!openSeg) return;
    const text = withTitle ? `${openSeg.title}\n\n${openSeg.content ?? ""}` : openSeg.content ?? "";
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 900);
    } catch {
      setStatus("Copy failed (clipboard blocked by browser).");
    }
  }

  function exportOpenSegmentTxt() {
    if (!openSeg) return;

    const docLabel = selectedUpload?.filename
      ? safeFileName(selectedUpload.filename)
      : `doc_${documentId ?? "unknown"}`;
    const segLabel = safeFileName(`${openSeg.orderIndex + 1}_${openSeg.title || "segment"}`);
    const fileName = `${docLabel}__${segLabel}.txt`;

    const content = `${openSeg.title}\n(mode: ${openSeg.mode}, order: ${
      openSeg.orderIndex + 1
    })\n\n${openSeg.content ?? ""}\n`;
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 300);
  }

  const segSummaryByMode = useMemo(() => {
    const map: Record<string, SegSummaryRow> = {};
    for (const row of segSummary) map[row.mode] = row;
    return map;
  }, [segSummary]);

  return (
    <div
      className="min-h-screen bg-background"
      style={{ maxWidth: 1400, margin: "32px auto", color: "#eaeaea", padding: "0 24px" }}
    >
      {/* Header */}
      <div className="bg-surface border border-border rounded-xl shadow-lg p-8 mb-10 bg-gradient-to-r from-surface to-surface-elevated/30">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-6">
            <div className="w-12 h-12 bg-primary rounded-xl flex items-center justify-center shadow-lg transform hover:scale-105 transition-transform duration-200">
              <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
            </div>
            <div>
              <h1 className="text-3xl font-bold text-primary bg-gradient-to-r from-primary to-primary/80 bg-clip-text text-transparent">
                AI Organizer
              </h1>
              <p className="text-secondary mt-1 text-lg">Document management and segmentation platform</p>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-right bg-surface/50 px-4 py-2 rounded-lg border border-border/50">
              <p className="text-sm text-secondary">Logged in as</p>
              <p className="font-medium text-primary">{user?.email}</p>
            </div>
            <button
              onClick={logout}
              className="btn-secondary px-5 py-2.5 bg-surface border border-border rounded-lg hover:bg-surface-elevated transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md hover:scale-105 transform"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                />
              </svg>
              Logout
            </button>
          </div>
        </div>
      </div>

      <div className="my-8 border-t border-border"></div>

      <div className="mb-8">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-8 h-8 bg-primary/20 rounded-lg flex items-center justify-center">
            <svg className="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
          </div>
          <h2 className="text-2xl font-semibold text-primary">Pick existing document</h2>
        </div>
        <div className="bg-surface/50 p-6 rounded-xl border border-border/50 shadow-sm">
          <div style={{ display: "flex", gap: 16, alignItems: "center", flexWrap: "wrap" }}>
            <select
              value={documentId ?? ""}
              onChange={(e) => {
                const v = e.target.value;
                setDocumentId(v ? Number(v) : null);
                setSegments([]);
                setOpenSeg(null);
                setQuery("");
                setModeFilter("all");
              }}
              style={{
                minWidth: 600,
                padding: "12px 16px",
                borderRadius: 10,
                border: "1px solid #444",
                background: "#0f0f0f",
                color: "#eaeaea",
                fontSize: 14,
                boxShadow: "0 2px 4px rgba(0,0,0,0.1)",
              }}
            >
              <option value="">-- Select uploaded document --</option>
              {uploads.map((u) => (
                <option key={u.documentId} value={u.documentId}>
                  {u.filename} • {statusBadge(u.parseStatus)} (docId={u.documentId})
                </option>
              ))}
            </select>

            <button
              onClick={fetchUploads}
              disabled={uploadsLoading}
              className="px-4 py-2.5 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md hover:scale-105 transform flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              {uploadsLoading ? "Refreshing..." : "Refresh list"}
            </button>

            <button
              onClick={deleteSelectedUpload}
              disabled={!selectedUpload || deleteLoading}
              className="px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md hover:scale-105 transform flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              {deleteLoading ? "Deleting..." : "Delete selected"}
            </button>
          </div>
        </div>
      </div>

      {/* Parse details */}
      {selectedUpload && (
        <div className="mt-6 p-6 rounded-xl border border-border bg-surface-elevated/50 shadow-sm">
          <div className="flex items-center gap-2 mb-4">
            <div className="w-6 h-6 bg-blue-500/20 rounded flex items-center justify-center">
              <svg className="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <h3 className="font-semibold text-primary">Document Details</h3>
          </div>
          <div style={{ display: "flex", justifyContent: "space-between", gap: 10, flexWrap: "wrap" }}>
            <div>
              <b>Parse status:</b> {statusBadge(selectedUpload.parseStatus)}
              {selectedUpload.parseStatus === "failed" && selectedUpload.parseError ? (
                <div style={{ marginTop: 8, color: "#ffb3b3", whiteSpace: "pre-wrap" }}>
                  <b>Parse error:</b> {selectedUpload.parseError}
                </div>
              ) : null}
            </div>

            <div style={{ opacity: 0.75 }}>
              <div>
                <b>Type:</b> {selectedUpload.contentType}
              </div>
              <div>
                <b>Size:</b> {selectedUpload.sizeBytes.toLocaleString()} bytes
              </div>
            </div>
          </div>

          <div style={{ marginTop: 10, opacity: 0.75 }}>
            Supported for now: <b>.txt .md .json (ChatGPT export) .docx</b> • Not supported: <b>.doc</b>{" "}
            (upload .docx).
          </div>
        </div>
      )}

      {/* Segmentation summary */}
      {documentId && (
        <div style={{ marginTop: 14 }}>
          <SegmentationSummaryBar
            qa={{
              count: segSummaryByMode.qa?.count ?? 0,
              last: segSummaryByMode.qa?.lastSegmentedAt ?? null,
            }}
            paragraphs={{
              count: segSummaryByMode.paragraphs?.count ?? 0,
              last: segSummaryByMode.paragraphs?.lastSegmentedAt ?? null,
            }}
            onRefresh={() => {
              if (documentId) loadSegmentationSummary(documentId);
            }}
            drawerTitle={`Document #${documentId} • Segmentation`}
          />
          
          {/* Document Action Buttons */}
          <div style={{ marginTop: 14, display: "flex", gap: 10, flexWrap: "wrap" }}>
            <button
              onClick={() => {
                nav(`/documents/${documentId}/view`);
              }}
              disabled={!documentId}
              className="px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md hover:scale-105 transform flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              View Document
            </button>
            <button
              onClick={() => {
                nav(`/documents/${documentId}`);
              }}
              disabled={!documentId}
              className="px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md hover:scale-105 transform flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              Open Workspace
            </button>
          </div>
        </div>
      )}

      <div className="my-8 border-t border-border"></div>

      <div className="mb-8">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center">
            <svg className="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
          </div>
          <h2 className="text-2xl font-semibold text-primary">Upload → Segment → List</h2>
        </div>

        <div className="bg-surface/50 p-6 rounded-xl border border-border/50 shadow-sm">
          <div className="flex flex-wrap gap-4 items-start mb-6">
            <div className="flex-1 min-w-80">
              <label className="block text-sm font-medium text-secondary mb-2">Choose file to upload</label>
              <input
                type="file"
                onChange={(e) => setFile(e.target.files?.[0] ?? null)}
                className="w-full p-3 rounded-lg border border-border bg-surface-elevated/50 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary file:text-white hover:file:bg-primary/90 cursor-pointer transition-all duration-200"
              />
            </div>
            <div className="flex items-end">
              <button
                onClick={doUpload}
                disabled={!file || uploadLoading}
                className="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md font-medium hover:scale-105 transform flex items-center gap-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                  />
                </svg>
                {uploadLoading ? "Uploading..." : "Upload"}
              </button>
            </div>
          </div>

          {/* ✅ THIS IS THE MISSING CLOSING DIV FIX:
              We are still inside the bg-surface wrapper, and we close it here. */}
        </div>

        {localDuplicateHint && (
          <p style={{ marginTop: 10, color: "#ffcc66" }}>
            Hint: This looks already uploaded as <b>docId={localDuplicateHint.documentId}</b>. Select it from the dropdown
            to avoid duplicates.
          </p>
        )}

        <div className="bg-surface/50 p-6 rounded-xl border border-border/50 shadow-sm">
          <div className="flex flex-wrap gap-4 items-center mb-4">
            <div className="flex items-center gap-2">
              <label className="font-medium text-secondary">Segmentation mode:</label>
              <select
                value={mode}
                onChange={(e) => setMode(e.target.value as any)}
                className="px-4 py-2.5 rounded-lg border border-border bg-surface-elevated/50 text-primary focus:outline-none focus:ring-2 focus:ring-primary/50"
              >
                <option value="qa">qa</option>
                <option value="paragraphs">paragraphs</option>
              </select>
            </div>

            <button
              onClick={segmentDoc}
              disabled={!documentId || !canSegment}
              className="px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md hover:scale-105 transform flex items-center gap-2"
              title={!canSegment ? "Document must be parseStatus=ok to segment." : ""}
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              Segment
            </button>

            <button
              onClick={loadSegments}
              disabled={!documentId}
              className="px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md hover:scale-105 transform flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
              List Segments
            </button>
          </div>
        </div>

        <p style={{ marginTop: 12, opacity: 0.85 }}>{status}</p>

        <div className="mt-8 rounded-xl border border-border/60 overflow-hidden shadow-lg bg-surface/20 backdrop-blur-sm">
          <div className="p-6 border-b border-border/40 bg-gradient-to-r from-surface-elevated/40 via-surface-elevated/20 to-transparent">
            <div className="flex justify-between items-center gap-4 flex-wrap">
              <div className="flex items-center gap-3">
                <div className="w-6 h-6 bg-purple-500/20 rounded flex items-center justify-center">
                  <svg className="w-3 h-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                  </svg>
                </div>
                <h3 className="text-lg font-semibold text-primary">Segments</h3>
              </div>
              <span className="text-sm font-medium px-3 py-1.5 rounded-full bg-gradient-to-r from-primary/20 to-primary/10 text-primary border border-primary/30">
                {segments.length ? `${filteredSegments.length}/${segments.length} segments` : "No segments"}
              </span>
            </div>

            <div className="mt-4 flex flex-wrap gap-3 items-center">
              <div className="flex-1 min-w-80 relative">
                <svg className="absolute left-3 top-1/2 transform -translate-y-1/2 w-3 h-3 text-secondary opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  placeholder="Search segments..."
                  className="w-full pl-8 pr-4 py-2.5 rounded-lg border border-border/60 bg-surface-elevated/30 text-primary placeholder:text-secondary/60 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary/50 transition-all duration-200"
                />
              </div>

              <select
                value={modeFilter}
                onChange={(e) => setModeFilter(e.target.value as any)}
                className="px-4 py-2.5 rounded-lg border border-border/60 bg-surface-elevated/30 text-primary focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary/50 transition-all duration-200"
              >
                <option value="all">All modes</option>
                <option value="qa">Q&A</option>
                <option value="paragraphs">Paragraphs</option>
              </select>

              <button
                onClick={() => {
                  setQuery("");
                  setModeFilter("all");
                }}
                disabled={!query && modeFilter === "all"}
                className="px-4 py-2.5 bg-surface/30 text-primary rounded-lg hover:bg-surface/50 transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed border border-border/40 hover:border-border/60 hover:scale-105 transform flex items-center gap-2 text-sm font-medium"
              >
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
                Clear
              </button>
            </div>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="text-left bg-gradient-to-r from-surface-elevated/20 to-transparent border-b border-border/60">
                  <th className="px-6 py-4 w-20 font-medium text-secondary text-sm uppercase tracking-wide">#</th>
                  <th className="px-6 py-4 w-36 font-medium text-secondary text-sm uppercase tracking-wide">Type</th>
                  <th className="px-6 py-4 w-96 font-medium text-secondary text-sm uppercase tracking-wide">Title</th>
                  <th className="px-6 py-4 font-medium text-secondary text-sm uppercase tracking-wide">Preview</th>
                </tr>
              </thead>
              <tbody>
                {!segments.length ? (
                  <tr>
                    <td colSpan={4} className="px-6 py-12 text-center opacity-60">
                      <div className="flex flex-col items-center gap-3">
                        <div className="w-12 h-12 bg-surface/30 rounded-full flex items-center justify-center">
                          <svg className="w-6 h-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                              strokeLinecap="round"
                              strokeLinejoin="round"
                              strokeWidth={2}
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                          </svg>
                        </div>
                        <div>
                          <p className="text-secondary font-medium">No segments loaded yet</p>
                          <p className="text-sm opacity-70 mt-1">
                            Click <span className="text-primary font-medium">List Segments</span> to get started
                          </p>
                        </div>
                      </div>
                    </td>
                  </tr>
                ) : !filteredSegments.length ? (
                  <tr>
                    <td colSpan={4} className="px-6 py-12 text-center opacity-60">
                      <div className="flex flex-col items-center gap-3">
                        <div className="w-12 h-12 bg-surface/30 rounded-full flex items-center justify-center">
                          <svg className="w-6 h-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                          </svg>
                        </div>
                        <div>
                          <p className="text-secondary font-medium">No results found</p>
                          <p className="text-sm opacity-70 mt-1">Try adjusting your search or filter</p>
                        </div>
                      </div>
                    </td>
                  </tr>
                ) : (
                  filteredSegments.map((s) => {
                    const isActive = openSeg?.id === s.id;
                    return (
                      <tr
                        key={s.id}
                        onClick={() => setOpenSeg(s)}
                        className={`cursor-pointer transition-colors duration-150 hover:bg-surface-elevated/20 ${
                          isActive ? "bg-primary/10 border-l-4 border-primary" : ""
                        }`}
                      >
                        <td className="px-6 py-4 border-b border-border/30 opacity-90">
                          <span className="text-sm font-mono bg-surface/40 px-2 py-1 rounded">#{s.orderIndex + 1}</span>
                        </td>
                        <td className="px-6 py-4 border-b border-border/30">
                          <span
                            className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${
                              s.mode === "qa"
                                ? "bg-blue-500/20 text-blue-400 border border-blue-500/30"
                                : "bg-green-500/20 text-green-400 border border-green-500/30"
                            }`}
                          >
                            {s.mode === "qa" ? "Q&A" : "Paragraph"}
                          </span>
                        </td>
                        <td className="px-6 py-4 border-b border-border/30">
                          <div className="font-medium text-primary hover:text-primary/80 transition-colors">{s.title}</div>
                        </td>
                        <td className="px-6 py-4 border-b border-border/30 opacity-75 text-sm">
                          <div className="line-clamp-2">{preview120(s.content)}</div>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Side panel */}
        {openSeg && (
          <>
            <div
              onClick={() => setOpenSeg(null)}
              style={{
                position: "fixed",
                inset: 0,
                background: "rgba(0,0,0,0.55)",
                zIndex: 50,
              }}
            />

            <div
              style={{
                position: "fixed",
                top: 0,
                right: 0,
                height: "100vh",
                width: "min(640px, 92vw)",
                background: "#0b0e14",
                borderLeft: "1px solid rgba(255,255,255,0.12)",
                zIndex: 60,
                display: "flex",
                flexDirection: "column",
                boxShadow: "-4px 0 24px rgba(0,0,0,0.3)",
              }}
            >
              <div className="p-6 border-b border-border flex gap-4 items-center bg-surface-elevated/30">
                <div className="flex-1">
                  <div className="font-bold text-lg">
                    {openSeg.orderIndex + 1}. {openSeg.title}
                  </div>
                  <div className="opacity-70 text-sm mt-1">mode: {openSeg.mode}</div>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={() => copyOpenSegment(false)}
                    className="px-3 py-2 bg-surface border border-border rounded-lg hover:bg-surface-elevated transition-all duration-200 text-sm"
                  >
                    {copied ? "Copied!" : "Copy"}
                  </button>

                  <button
                    onClick={() => copyOpenSegment(true)}
                    className="px-3 py-2 bg-surface border border-border rounded-lg hover:bg-surface-elevated transition-all duration-200 text-sm"
                  >
                    Copy Title+Text
                  </button>

                  <button
                    onClick={exportOpenSegmentTxt}
                    className="px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all duration-200 text-sm"
                  >
                    Export .txt
                  </button>

                  <button
                    onClick={() => setOpenSeg(null)}
                    className="px-3 py-2 bg-surface border border-border rounded-lg hover:bg-surface-elevated transition-all duration-200 text-sm"
                  >
                    Close
                  </button>

                  <button
                    onClick={() => nav(`/segments/${openSeg.id}`)}
                    className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200 text-sm"
                  >
                    Open details
                  </button>
                </div>
              </div>

              <div className="p-6 overflow-auto">
                <pre className="whitespace-pre-wrap leading-relaxed">{openSeg.content}</pre>
              </div>
            </div>
          </>
        )}
      </div>
    </div>
  );
}
